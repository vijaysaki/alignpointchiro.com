<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS5RQ53S2J"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YS5RQ53S2J');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlignPoint Chiropractic</title>
  <meta name="description" content="AlignPoint Chiropractic in Lexington, KY." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* Small safety defaults if style.css is missing pieces */
    .nav-list { list-style:none; margin:0; padding:0; display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .nav-list > li { position:relative; }
    .nav-link, .nav-btn { font: inherit; background:none; border:0; cursor:pointer; padding:10px 10px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .has-dropdown .dropdown { display:none; position:absolute; left:0; top:100%; z-index:999; min-width:260px; background:#fff; border:1px solid rgba(0,0,0,.1); border-radius:12px; padding:12px; box-shadow:0 14px 40px rgba(0,0,0,.12); }
    .has-dropdown.open > .dropdown { display:block; }
    .dropdown a { display:block; padding:8px 10px; border-radius:10px; text-decoration:none; }
    .dropdown a:hover { background:rgba(0,0,0,.06); }
    .dropdown-simple {
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:220px;
    }
    .dropdown-simple a {
      padding:8px 10px;
      border-radius:8px;
      color:#0b5fff;
      font-weight:600;
    }
    .dd-cols { display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:10px; }
    .dd-col { padding:6px; }
    .dd-title { font-weight:700; margin:6px 10px; opacity:.85; }
    .chev { width:8px; height:8px; border-right:2px solid currentColor; border-bottom:2px solid currentColor; transform: rotate(45deg); display:inline-block; margin-top:-2px; }
    @media (max-width: 900px){
      .dd-cols { grid-template-columns: 1fr; }
      .has-dropdown .dropdown { position:static; box-shadow:none; border-radius:10px; margin-top:6px; }
      .nav-list { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>

<body class="theme">
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header" id="top">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="container topbar-inner">
        <a class="brand" href="index.html" aria-label="AlignPoint Chiropractic Home">
          <img src="assets/alignpoint-logo-dark.png" class="brand-logo" alt="AlignPoint Chiropractic">
        </a>

        <button class="nav-toggle" aria-expanded="false" aria-controls="siteNav" aria-label="Open menu">
          <span></span><span></span><span></span>
        </button>

        <div class="topbar-right">
          <div class="header-contact">
            <div class="header-address">
              1132 Winchester Rd
              Suite #125
              Lexington, KY 40505 | <a href="tel:+18592540059">(859) 254-0059</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MENU BAR (DYNAMIC) -->
    <div class="menubar">
      <div class="container menubar-inner">
        <nav class="site-nav" id="siteNav" aria-label="Primary navigation">
          <!-- We will inject UL here -->
          <ul class="nav-list" id="navList"></ul>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <!-- IGNORE CONTENT (placeholder) -->
    <section class="section">
      <div class="container">
        <div id="alignpoint-content"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-bottom">
      <span>Â© <span id="year"></span> AlignPoint Chiropractic</span>
      <a class="footer-link" href="#top">Back to top</a>
    </div>
  </footer>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://api.adeptlogics.com/public";
    const tenantDomain = "alignpointchiro.com";

    // This API menu is the header menu with dropdown data
    const MENU_SLUG = "header";
    const DEFAULT_SLUG = "home";

    const pagesBySlug = new Map();
    const slugTitleMap = new Map();
    let currentSlug = slugFromPath();

    function slugFromPath() {
      const path = window.location.pathname || "/";
      const segments = path.split("/").filter(Boolean);
      let slug = segments.pop() || "";
      slug = slug.replace(/\.html$/i, "");
      if (!slug || slug === "index") {
        return DEFAULT_SLUG;
      }
      return slug;
    }

    async function fetchJson(endpoint) {
      const res = await fetch(`${API_BASE}${endpoint}`);
      if (!res.ok) throw new Error(`API error ${res.status}`);
      return res.json();
    }

    function buildTree(items = []) {
      const byId = new Map();
      const roots = [];

      for (const it of items) {
        byId.set(it.id, { ...it, children: [] });
      }

      for (const it of byId.values()) {
        if (it.parent_id && byId.has(it.parent_id)) {
          byId.get(it.parent_id).children.push(it);
        } else {
          roots.push(it);
        }
      }

      const sortRec = (nodeList) => {
        nodeList.sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0));
        nodeList.forEach(n => sortRec(n.children));
      };

      sortRec(roots);
      return roots;
    }

    function getHref(item) {
      if (item.external_url) return item.external_url;
      if (item.page?.full_path) {
        if (item.page.slug === DEFAULT_SLUG) return "/";
        return item.page.full_path || `/${item.page.slug}`;
      }
      if (item.page?.slug) {
        return item.page.slug === DEFAULT_SLUG ? "/" : `/${item.page.slug}`;
      }
      return "#";
    }

    function pathForSlug(slug) {
      const page = pagesBySlug.get(slug);
      if (page?.full_path) {
        if (slug === DEFAULT_SLUG) return page.full_path === "/home" ? "/" : page.full_path;
        return page.full_path;
      }

      if (slug === DEFAULT_SLUG) return "/";
      return `/${slug}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function makeLink(label, href, extraClass) {
      const a = document.createElement("a");
      if (extraClass) a.className = extraClass;
      a.textContent = label || "(no label)";
      a.href = href || "#";
      return a;
    }

    function registerSlug(slug, label) {
      if (!slug) return;
      slugTitleMap.set(slug, label || slug);
    }

    function renderMenuFromItems(items = []) {
      const navList = document.getElementById("navList");
      if (!navList) return;
      navList.innerHTML = "";
      const visible = (items || []).filter(item => item.visible);
      const tree = buildTree(visible);
      tree.forEach(node => navList.appendChild(renderNavItem(node)));
    }

    function renderNavItem(node) {
      const li = document.createElement("li");
      const children = (node.children || []).filter(child => child.visible);
      if (children.length) {
        li.className = "has-dropdown";
        const btn = document.createElement("button");
        btn.className = "nav-link nav-btn";
        btn.type = "button";
        btn.setAttribute("aria-expanded", "false");
        btn.innerHTML = `${escapeHtml(node.label || "Menu")} <span class="chev" aria-hidden="true"></span>`;

        const dropdown = document.createElement("div");
        dropdown.className = "dropdown";
        dropdown.setAttribute("role", "menu");

        const hasNestedChildren = children.some(child => (child.children || []).filter(grand => grand.visible).length);
        if (hasNestedChildren) {
          const cols = document.createElement("div");
          cols.className = "dd-cols";

          children.forEach(child => {
            const col = document.createElement("div");
            col.className = "dd-col";

            const title = document.createElement("div");
            title.className = "dd-title";
            title.textContent = child.label || "Section";
            col.appendChild(title);

            const grandchildren = (child.children || []).filter(grand => grand.visible);
            if (grandchildren.length) {
              grandchildren.forEach(grand => {
                const a = document.createElement("a");
                a.href = getHref(grand);
                a.textContent = grand.label || "(no label)";
                col.appendChild(a);
              });
            } else {
              col.appendChild(createDropdownLink(child));
            }

            cols.appendChild(col);
          });

          dropdown.appendChild(cols);
        } else {
          const simple = document.createElement("div");
          simple.className = "dropdown-simple";
          children.forEach(child => {
            simple.appendChild(createDropdownLink(child));
          });
          dropdown.appendChild(simple);
        }

        li.appendChild(btn);
        li.appendChild(dropdown);

        btn.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = li.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(isOpen));
          if (isOpen) {
            closeDropdowns(li);
          }
        });

        li.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            li.classList.remove("open");
            btn.setAttribute("aria-expanded", "false");
            btn.focus();
          }
        });

        return li;
      }

      registerSlug(node.page?.slug, node.label);
      li.appendChild(createInteractiveLink(node.label, getHref(node), node.page?.slug));
      return li;
    }

    function createInteractiveLink(label, href, slug) {
      const link = makeLink(label, href, "nav-link");
      if (slug) {
        link.dataset.slug = slug;
        link.addEventListener("click", onNavLinkClick);
      }
      return link;
    }

    function createDropdownLink(item) {
      const href = getHref(item);
      const link = makeLink(item.label, href);
      registerSlug(item.page?.slug, item.label);
      if (item.page?.slug) {
        link.dataset.slug = item.page.slug;
        link.addEventListener("click", onNavLinkClick);
      }
      return link;
    }

    function onNavLinkClick(event) {
      if (
        event.defaultPrevented ||
        event.metaKey ||
        event.ctrlKey ||
        event.shiftKey ||
        event.button !== 0
      ) {
        return;
      }

      const slug = event.currentTarget.dataset.slug;
      if (!slug) return;
      event.preventDefault();
      navigateToSlug(slug);
    }

    function renderContent(page, slug) {
      const contentEl = document.getElementById("alignpoint-content");
      if (!contentEl) return;
      if (!page) {
        contentEl.innerHTML = "<p>Content not found.</p>";
        document.title = "AlignPoint Chiropractic";
        return;
      }
      contentEl.innerHTML = page.content || "<p>Content is empty.</p>";
      const label = slugTitleMap.get(slug) || page.slug;
      const title = label ? `AlignPoint Chiropractic | ${label}` : "AlignPoint Chiropractic";
      document.title = title;
    }

    function updateActiveLinks(slug) {
      document.querySelectorAll("#navList a[data-slug]").forEach(link => {
        link.classList.toggle("is-active", link.dataset.slug === slug);
      });
    }

    async function navigateToSlug(slug, { pushState = true } = {}) {
      const targetSlug = slug || DEFAULT_SLUG;
      const page = pagesBySlug.get(targetSlug);
      if (!page) {
        renderContent(null, targetSlug);
        updateActiveLinks(targetSlug);
        return;
      }
      renderContent(page, targetSlug);
      updateActiveLinks(targetSlug);
      if (pushState) {
        const url = pathForSlug(targetSlug);
        history.pushState({ slug: targetSlug }, "", url);
      }
      currentSlug = targetSlug;
    }

    function closeDropdowns(except) {
      document.querySelectorAll(".has-dropdown.open").forEach(li => {
        if (li === except) return;
        li.classList.remove("open");
        const btn = li.querySelector("button.nav-btn");
        if (btn) btn.setAttribute("aria-expanded", "false");
      });
    }

    document.addEventListener("click", () => {
      closeDropdowns();
    });

    (function setupMobileToggle() {
      const toggle = document.querySelector(".nav-toggle");
      const nav = document.getElementById("siteNav");
      if (!toggle || !nav) return;
      toggle.addEventListener("click", () => {
        const expanded = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", String(!expanded));
        nav.classList.toggle("open");
      });
    })();

    async function initNav() {
      const domain = encodeURIComponent(tenantDomain);
      const [pages, menus] = await Promise.all([
        fetchJson(`/pages?domain=${domain}`),
        fetchJson(`/pages/menus?domain=${domain}`),
      ]);

      (pages || []).forEach(page => {
        if (page.slug) {
          pagesBySlug.set(page.slug, page);
        }
      });

      const menu = (menus || []).find(m => m.slug === MENU_SLUG) || (menus || [])[0];
      if (menu) {
        renderMenuFromItems(menu.items || []);
      }

      await navigateToSlug(currentSlug, { pushState: false });
      history.replaceState({ slug: currentSlug }, "", pathForSlug(currentSlug));

      window.addEventListener("popstate", event => {
        const slug = event.state?.slug || slugFromPath();
        if (slug !== currentSlug) {
          navigateToSlug(slug, { pushState: false });
        }
      });
    }

    document.getElementById("year").textContent = String(new Date().getFullYear());

    initNav().catch(err => {
      console.error("Failed to load AlignPoint data", err);
    });
  </script>

  <script src="js/script.js"></script>
</body>
</html>
