<?php
require __DIR__ . '/db.php';
require __DIR__ . '/header.php';

$rows = db()->query("SELECT id, parent_id, title, slug, sort_order FROM services ORDER BY sort_order, title")->fetchAll();

// group by parent
$byParent = [];
foreach ($rows as $r) {
  $pid = $r['parent_id'] === null ? 0 : (int)$r['parent_id'];
  $byParent[$pid][] = $r;
}

function renderTree(array $byParent, int $parentId = 0, int $depth = 0): void {
  if (!isset($byParent[$parentId])) return;
  echo "<ul>";
  foreach ($byParent[$parentId] as $r) {
    $pad = str_repeat('&nbsp;&nbsp;&nbsp;', $depth);
    $id = (int)$r['id'];
    echo "<li>{$pad}" . e($r['title']) . " (<code>" . e($r['slug']) . "</code>) ";
    echo "<a href='service_edit.php?id={$id}'>Edit</a></li>";
    renderTree($byParent, $id, $depth + 1);
  }
  echo "</ul>";
}
?>
<h1>Services</h1>
<p><a href="service_edit.php">+ New Service</a></p>

<?php renderTree($byParent); ?>

<?php require __DIR__ . '/footer.php'; ?>
